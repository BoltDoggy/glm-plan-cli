# 功能规格说明：GLM API 计划查询命令

**功能分支**: `001-glm-cli-command`
**创建日期**: 2026-01-13
**状态**: 草稿
**用户描述**: "实现 glm 命令"

## 用户场景与测试 *(必填)*

### 用户故事 1 - 查询 API 计划使用情况 (优先级: P1)

作为 GLM API 用户，我需要通过命令行快速查询我的 API 计划使用情况，以便了解剩余额度和使用进度。

**为什么是这个优先级**: 这是工具的核心功能，解决了用户的基本需求 - 了解 API 使用情况。没有这个功能，工具无法提供任何价值。

**独立测试**: 可以通过执行命令并验证输出来独立测试。用户能够获得计划信息（总额度、已用量、剩余量、有效期等），并且输出格式清晰易读。

**验收场景**:

1. **给定** 用户已配置有效的 API 密钥，**当** 执行 `glm` 命令，**那么** 显示完整的计划信息，包括总额度、已使用量、剩余量和有效期
2. **给定** 用户未配置 API 密钥，**当** 执行 `glm` 命令，**那么** 显示清晰的中文错误提示，说明如何配置 API 密钥
3. **给定** API 密钥无效或已过期，**当** 执行 `glm` 命令，**那么** 显示友好的中文错误信息，提示检查密钥配置
4. **给定** 网络连接不可用，**当** 执行 `glm` 命令，**那么** 显示网络错误提示，建议检查网络连接

---

### 用户故事 2 - 多种输出格式支持 (优先级: P2)

作为 GLM API 用户，我希望能够选择不同的输出格式（如表格、JSON），以便在不同的场景下使用（终端查看、脚本处理、数据存档）。

**为什么是这个优先级**: 虽然表格输出能满足基本需求，但 JSON 格式对于自动化脚本和集成非常重要。这是增强用户体验的功能，但不影响核心价值。

**独立测试**: 可以通过执行带有格式参数的命令并验证输出格式来独立测试。用户能够获得指定格式的输出，且不同格式的输出内容一致。

**验收场景**:

1. **给定** 用户执行 `glm --format table`，**当** 命令执行，**那么** 以易读的表格格式显示计划信息（默认格式）
2. **给定** 用户执行 `glm --format json`，**当** 命令执行，**那么** 以结构化的 JSON 格式输出计划信息
3. **给定** 用户提供了无效的格式参数，**当** 命令执行，**那么** 显示错误信息并列出支持的格式选项

---

### 用户故事 3 - 详细的错误提示和使用帮助 (优先级: P3)

作为 GLM API 用户，我需要清晰的错误提示和帮助文档，以便快速上手并在遇到问题时自助解决。

**为什么是这个优先级**: 帮助文档和错误提示是用户体验的重要组成部分，但可以在核心功能实现后再完善。良好的错误处理能显著降低学习成本。

**独立测试**: 可以通过执行帮助命令和触发各种错误场景来独立测试。用户能够获得清晰的操作指引和问题解决方案。

**验收场景**:

1. **给定** 用户执行 `glm --help`，**当** 命令执行，**那么** 显示完整的中文使用说明，包括所有命令选项和示例
2. **给定** 用户执行 `glm --version`，**当** 命令执行，**那么** 显示当前工具的版本号
3. **给定** API 返回错误（如超时、限流），**当** 命令执行，**那么** 显示可操作的中文错误信息，说明问题和建议的解决方法
4. **给定** 配置文件格式错误，**当** 命令执行，**那么** 指出配置文件的具体错误位置和修正建议

---

### 边界情况

- 当 API 响应时间过长（超过 30 秒）时会发生什么？
- 当 API 返回的数据结构与预期不符时如何处理？
- 当用户的终端不支持某些字符（如表格边框）时如何降级显示？
- 当用户同时提供了环境变量和配置文件中的 API 密钥时，以哪个为准？

## 需求 *(必填)*

### 功能需求

- **FR-001**: 系统必须允许用户通过命令行查询 GLM API 计划信息
- **FR-002**: 系统必须支持通过环境变量 `GLM_API_KEY` 配置 API 密钥
- **FR-003**: 系统必须支持通过配置文件 `~/.glm/config.yaml` 配置 API 密钥
- **FR-004**: 当同时存在多个配置源时，环境变量优先级高于配置文件
- **FR-005**: 系统必须以表格格式（默认）显示计划信息，包括：总额度、已使用量、剩余量、有效期、使用百分比
- **FR-006**: 系统必须支持 `--format` 参数，允许用户选择输出格式（table、json）
- **FR-007**: 系统必须提供 `--help` 参数，显示完整的中文使用说明
- **FR-008**: 系统必须提供 `--version` 参数，显示当前版本号
- **FR-009**: 所有错误信息必须使用中文，并包含：问题描述、原因说明、解决建议
- **FR-010**: 系统必须在 30 秒内完成 API 请求并显示结果，超时后显示超时错误
- **FR-011**: 系统必须对敏感信息（如 API 密钥）进行掩码处理，不在日志或错误信息中完整显示
- **FR-012**: 系统必须验证 API 响应的数据完整性，当数据缺失或格式异常时显示友好的错误提示

### 关键实体 *(如果功能涉及数据)*

- **API 计划信息 (API Plan)**: 代表用户的 GLM API 使用计划
  - **总额度 (Total Quota)**: 计划的总 token 额度或请求数量
  - **已使用量 (Used Quota)**: 已经消耗的 token 数量或请求数量
  - **剩余量 (Remaining Quota)**: 剩余可用的 token 数量或请求数量
  - **有效期 (Validity Period)**: 计划的开始和结束日期
  - **使用百分比 (Usage Percentage)**: 已使用量占总额度的百分比

- **配置信息 (Configuration)**: 用户的工具配置
  - **API 密钥 (API Key)**: 用于身份验证的密钥
  - **配置来源 (Config Source)**: 环境变量或配置文件
  - **配置文件路径 (Config File Path)**: 配置文件的完整路径（如 `~/.glm/config.yaml`）

## 成功标准 *(必填)*

### 可衡量的结果

- **SC-001**: 用户可以在 5 秒内完成一次计划查询（从执行命令到看到结果）
- **SC-002**: 所有错误信息都能在 3 秒内显示给用户，并提供明确的解决步骤
- **SC-003**: 95% 的用户能够在没有外部帮助的情况下，通过帮助文档成功配置并使用工具
- **SC-004**: 工具能够处理所有已知 API 错误场景（认证失败、网络错误、超时、限流），并提供可操作的中文提示
- **SC-005**: 表格输出格式在各种终端环境下（支持 Unicode 和不支持 Unicode）都能正确显示
- **SC-006**: JSON 输出格式符合标准 JSON 规范，可以被常见的 JSON 解析工具正确解析
- **SC-007**: 工具的内存使用不超过 50MB，在低端系统上也能流畅运行

## 假设

1. **API 接口**: 假设 GLM API 提供了用于查询计划信息的 RESTful 端点，返回包含计划详细信息的 JSON 响应
2. **认证方式**: 假设使用标准的 API Key 认证方式，通过 HTTP Header 传递密钥
3. **数据格式**: 假设 API 响应包含总额度、已使用量、有效期等核心字段
4. **用户环境**: 假设用户使用支持 UTF-8 的现代终端环境
5. **网络环境**: 假设用户有稳定的网络连接，能够访问 GLM API 服务端点
6. **配置文件格式**: 假设使用 YAML 格式的配置文件，因为它易读且广泛支持
7. **错误处理**: 假设 API 会在响应中提供错误代码和描述信息，工具可以据此提供更友好的提示
8. **并发限制**: 假设单个用户不会同时执行多个查询命令，工具不需要处理并发场景

## 依赖

- GLM API 服务可用且响应时间在可接受范围内（< 10 秒）
- 用户拥有有效的 GLM API 密钥
- 用户的系统环境支持运行命令行工具
- 用户拥有基本的命令行操作知识（如何打开终端、执行命令等）

## 范围外

以下内容明确不在本功能范围内：

- 实时监控或自动刷新计划信息
- 历史使用数据的存储和查询
- 多个 API 密钥的管理和切换
- 图形化界面（GUI）
- API 使用预测或分析功能
- 与其他工具或平台的集成
- API 密钥的生成或管理功能
- 批量查询多个账户的计划信息
